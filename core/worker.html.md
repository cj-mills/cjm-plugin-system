# Universal Worker


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

The Universal Worker is a FastAPI server that:

1.  **Dynamically loads** a plugin class specified via CLI arguments
2.  **Exposes HTTP endpoints** for plugin lifecycle and execution
3.  **Monitors parent process** (“Suicide Pact”) to prevent zombie
    workers
4.  **Reports telemetry** for resource scheduling decisions

<!-- -->

    Host Process                    Worker Process (Isolated Env)
    ┌──────────────┐               ┌─────────────────────────────┐
    │ RemoteProxy  │──HTTP/JSON───▶│ Universal Worker (FastAPI)  │
    │              │               │   ├─ /health                │
    │  --ppid ─────│───────────────│──▶│ ├─ /initialize          │
    │              │               │   ├─ /execute               │
    └──────────────┘               │   ├─ /execute_stream        │
                                   │   └─ PID Watchdog (Thread)  │
                                   └─────────────────────────────┘

## EnhancedJSONEncoder

Custom JSON encoder that handles dataclasses and other common Python
types that need serialization for HTTP responses.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-plugin-system/blob/main/cjm_plugin_system/core/worker.py#L35"
target="_blank" style="float:right; font-size:smaller">source</a>

### EnhancedJSONEncoder

``` python

def EnhancedJSONEncoder(
    skipkeys:bool=False, ensure_ascii:bool=True, check_circular:bool=True, allow_nan:bool=True, sort_keys:bool=False,
    indent:NoneType=None, separators:NoneType=None, default:NoneType=None
):

```

*JSON encoder that handles dataclasses and other common types.*

``` python
# Test EnhancedJSONEncoder
from dataclasses import dataclass

@dataclass
class SampleConfig:
    name: str
    value: int

cfg = SampleConfig(name="test", value=42)
result = json.dumps(cfg, cls=EnhancedJSONEncoder)
print(f"Encoded: {result}")
assert json.loads(result) == {"name": "test", "value": 42}
```

    Encoded: {"name": "test", "value": 42}

## PID Watchdog

The “Suicide Pact” pattern: if the Host process dies, the Worker must
terminate itself to prevent zombie processes consuming resources.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-plugin-system/blob/main/cjm_plugin_system/core/worker.py#L48"
target="_blank" style="float:right; font-size:smaller">source</a>

### parent_monitor

``` python

def parent_monitor(
    ppid:int, # Parent process ID to monitor
)->None:

```

*Monitor parent process and terminate self if parent dies.*

This implements the “Suicide Pact” pattern: if the Host process dies,
the Worker must terminate itself to prevent zombie processes.

The watchdog runs in a daemon thread, checking every second if the
parent process is still alive. When the parent dies (or becomes a
zombie), the worker terminates itself using
[`terminate_self()`](https://cj-mills.github.io/cjm-plugin-system/core/platform.html#terminate_self)
which handles cross-platform differences (SIGTERM on Unix, `os._exit()`
on Windows).

## Application Factory

Creates the FastAPI application with all endpoints for plugin
communication.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-plugin-system/blob/main/cjm_plugin_system/core/worker.py#L68"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_app

``` python

def create_app(
    module_name:str, # Python module path (e.g., "my_plugin.plugin")
    class_name:str, # Plugin class name (e.g., "WhisperPlugin")
)->FastAPI: # Configured FastAPI application

```

*Create FastAPI app that hosts the specified plugin.*

### Endpoint Summary

<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/health</code></td>
<td>GET</td>
<td>Health check with PID and plugin identity</td>
</tr>
<tr>
<td><code>/stats</code></td>
<td>GET</td>
<td>Process telemetry (CPU, memory) for scheduler</td>
</tr>
<tr>
<td><code>/initialize</code></td>
<td>POST</td>
<td>Configure/reconfigure plugin</td>
</tr>
<tr>
<td><code>/config_schema</code></td>
<td>GET</td>
<td>JSON Schema for UI generation</td>
</tr>
<tr>
<td><code>/config</code></td>
<td>GET</td>
<td>Current configuration values</td>
</tr>
<tr>
<td><code>/execute</code></td>
<td>POST</td>
<td>Execute plugin, return JSON</td>
</tr>
<tr>
<td><code>/execute_stream</code></td>
<td>POST</td>
<td>Execute with streaming NDJSON response</td>
</tr>
<tr>
<td><code>/cancel</code></td>
<td>POST</td>
<td>Request cancellation of running execution</td>
</tr>
<tr>
<td><code>/progress</code></td>
<td>GET</td>
<td>Get current execution progress and status</td>
</tr>
<tr>
<td><code>/cleanup</code></td>
<td>POST</td>
<td>Release plugin resources</td>
</tr>
</tbody>
</table>

## CLI Entry Point

The worker is launched as a subprocess with the plugin module/class and
port specified via command line arguments.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-plugin-system/blob/main/cjm_plugin_system/core/worker.py#L221"
target="_blank" style="float:right; font-size:smaller">source</a>

### run_worker

``` python

def run_worker(
    
)->None:

```

*CLI entry point for running the worker.*

### Usage

The worker is typically launched by the
[`RemotePluginProxy`](https://cj-mills.github.io/cjm-plugin-system/core/proxy.html#remotepluginproxy):

``` bash
# Example: Launch a Whisper plugin worker
python -m cjm_plugin_system.core.worker \
    --module cjm_transcription_plugin_whisper.plugin \
    --class WhisperLocalPlugin \
    --port 12345 \
    --ppid 1234
```

The `--ppid` argument enables the suicide pact: if process 1234 dies,
this worker terminates.
